#!/usr/bin/env ruby

require 'awesome_print'
require 'date'
require 'colorize'
require 'rodzilla'
require 'mothra'

@config = YAML.load_file 'config.yml'

@bz = Rodzilla::Resource::Bug.new(@config['BZ_URL'], @config['BZ_USER'], @config['BZ_PASSWD'], :json)

def search(keyword)
  half_years_ago = DateTime.now - 180
  results = @bz.search(product: @config['PRODUCT'], 
                       component: @config['COMPONENT'], 
                       creation_time: half_years_ago, 
                       status: @config['STATUS'], 
                       summary: keyword
                      )

  if not results['bugs'].empty?
    results['bugs'].each_with_index do |r, i|
      print "[#{r['id']}] ".yellow
      print "[#{r['status']}] ".cyan
      print "#{r['summary']} ".white
      puts "[#{r['last_change_time']}] ".gray
    end
  else
    puts 'Not found.'
  end


end

def create
  begin
    ret = @bz.create(product: @config['PRODUCT'],
                     component: @config['COMPONENT'],
                     version: '1.0',
                     op_sys: 'FreeBSD',
                     platform: 'All',
                     #version: 'Latest',
                     #severity: 'Affects Only Me',
                     #op_sys: 'Any',
                     #platform: 'Any',
                     summary: 'just a test',
                     description: 'just a normal test',
                    )

    print 'PR'
    print " #{ret['id']} ".yellow
    puts "created!"
  rescue
    puts 'Send-pr fail, please try again!'.yellow
  end
end

#search 'broken'
#create
